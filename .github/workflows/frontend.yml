name: Build and Deploy React App to S3 + CloudFront (OAC)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Prepare environment and install dependencies
        run: |
          cd public
          mv .env.example .env
          yarn

      - name: Build project
        run: |
          cd public
          CI=false yarn build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create S3 bucket if not exists
        run: |
          BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          REGION="${{ secrets.AWS_REGION }}"

          if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Creating bucket $BUCKET_NAME in region $REGION..."
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" \
                --create-bucket-configuration LocationConstraint="$REGION"
            fi
          else
            echo "Bucket $BUCKET_NAME already exists."
          fi

          # Block all public access
          aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
            --public-access-block-configuration '{
              "BlockPublicAcls": true,
              "IgnorePublicAcls": true,
              "BlockPublicPolicy": true,
              "RestrictPublicBuckets": true
            }'

      - name: Create or get CloudFront OAC and Distribution
        id: cloudfront
        run: |
          BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          REGION="${{ secrets.AWS_REGION }}"
          ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"

          # 1. Create or get OAC
          OAC_NAME="$BUCKET_NAME-oac"
          OAC_ID=$(aws cloudfront list-origin-access-controls \
            --query "OriginAccessControlList.Items[?Name=='$OAC_NAME'].Id" --output text)

          if [ -z "$OAC_ID" ] || [ "$OAC_ID" = "None" ]; then
            echo "Creating CloudFront Origin Access Control..."
            OAC_ID=$(aws cloudfront create-origin-access-control \
              --origin-access-control-config "{
                \"Name\": \"$OAC_NAME\",
                \"Description\": \"OAC for $BUCKET_NAME\",
                \"SigningProtocol\": \"sigv4\",
                \"SigningBehavior\": \"always\",
                \"OriginAccessControlOriginType\": \"s3\"
              }" \
              --query "OriginAccessControl.Id" --output text)
          fi
          echo "OAC_ID=$OAC_ID" >> $GITHUB_ENV

          # 2. Create or get CloudFront distribution
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[?DomainName=='$BUCKET_NAME.s3.amazonaws.com']].Id" \
            --output text)

          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "Creating CloudFront distribution..."
            DIST_ID=$(aws cloudfront create-distribution \
              --distribution-config "{
                \"CallerReference\": \"$(date +%s)\",
                \"Origins\": {
                  \"Items\": [
                    {
                      \"Id\": \"$BUCKET_NAME-origin\",
                      \"DomainName\": \"$BUCKET_NAME.s3.amazonaws.com\",
                      \"OriginAccessControlId\": \"$OAC_ID\"
                    }
                  ],
                  \"Quantity\": 1
                },
                \"DefaultCacheBehavior\": {
                  \"TargetOriginId\": \"$BUCKET_NAME-origin\",
                  \"ViewerProtocolPolicy\": \"redirect-to-https\",
                  \"AllowedMethods\": {\"Quantity\": 2, \"Items\": [\"GET\",\"HEAD\"]},
                  \"CachedMethods\": {\"Quantity\": 2, \"Items\": [\"GET\",\"HEAD\"]},
                  \"ForwardedValues\": {\"QueryString\": false, \"Cookies\": {\"Forward\": \"none\"}},
                  \"MinTTL\": 0,
                  \"DefaultTTL\": 86400,
                  \"MaxTTL\": 31536000
                },
                \"Enabled\": true,
                \"Comment\": \"CloudFront with OAC for $BUCKET_NAME\"
              }" \
              --query "Distribution.Id" --output text)
          fi
          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV

          # 3. Attach bucket policy for OAC
          cat > policy.json <<POLICY
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontOAC",
      "Effect": "Allow",
      "Principal": { "Service": "cloudfront.amazonaws.com" },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::$BUCKET_NAME/*",
      "Condition": {
        "StringEquals": {
          "AWS:SourceArn": "arn:aws:cloudfront::$ACCOUNT_ID:distribution/$DIST_ID"
        }
      }
    }
  ]
}
POLICY

          aws s3api put-bucket-policy --bucket "$BUCKET_NAME" --policy file://policy.json

      - name: Upload build folder to S3
        run: |
          aws s3 sync public/build s3://${{ secrets.S3_BUCKET_NAME }} --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*"

      - name: Show CloudFront URL
        run: |
          CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution --id $DIST_ID \
            --query "Distribution.DomainName" --output text)
          echo "âœ… Your app is live at: https://$CLOUDFRONT_DOMAIN"
